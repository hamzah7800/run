<!DOCTYPE html>
<html>
<head>
  <title>Jetpack Parkour Fixed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    html, body { margin: 0; overflow: hidden; background: #111; }
    canvas { display: block; touch-action: none; }

    .btn {
      position: absolute;
      width: 80px;
      height: 80px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      font-size: 26px;
      text-align: center;
      line-height: 80px;
      color: white;
      user-select: none;
    }

    #leftBtn { left: 20px; bottom: 30px; }
    #rightBtn { left: 110px; bottom: 30px; }
    #jumpBtn { right: 110px; bottom: 30px; }
    #jetpackBtn { right: 20px; bottom: 30px; }
  </style>
</head>
<body>

<div id="leftBtn" class="btn">‚¨ÖÔ∏è</div>
<div id="rightBtn" class="btn">‚û°Ô∏è</div>
<div id="jumpBtn" class="btn">ü¶ò</div>
<div id="jetpackBtn" class="btn">üöÄ</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

// Player
const player = new THREE.Mesh(
  new THREE.BoxGeometry(1, 2, 1),
  new THREE.MeshBasicMaterial({ color: 0x00ff00 })
);
player.position.y = 5;
scene.add(player);

// Platforms
const platforms = [];
const platformSize = 6;
const platformTypes = ['static', 'disappear', 'move'];

function createPlatform(x, y, z, type) {
  let color = 0x3333ff;
  if (type === 'disappear') color = 0xff3333;
  if (type === 'move') color = 0xffff33;

  const mesh = new THREE.Mesh(
    new THREE.BoxGeometry(platformSize, 1, platformSize),
    new THREE.MeshBasicMaterial({ color })
  );
  mesh.position.set(x, y, z);
  scene.add(mesh);

  platforms.push({
    mesh,
    type,
    startZ: z,
    direction: 1,
    touchedAt: null
  });
}

// Generate path of platforms going forward in Z direction
for (let i = 0; i < 30; i++) {
  const z = i * 8;
  const x = (Math.floor(Math.random() * 3) - 1) * 6;
  const type = platformTypes[Math.floor(Math.random() * platformTypes.length)];
  createPlatform(x, -0.5, z, type);
}

let velocity = new THREE.Vector3();
let isJetpacking = false;
let moveLeft = false;
let moveRight = false;
let onGround = false;
let jetpackFuel = 100;

// Movement buttons
document.getElementById("leftBtn").addEventListener("touchstart", () => moveLeft = true);
document.getElementById("leftBtn").addEventListener("touchend", () => moveLeft = false);
document.getElementById("rightBtn").addEventListener("touchstart", () => moveRight = true);
document.getElementById("rightBtn").addEventListener("touchend", () => moveRight = false);

// Jump
document.getElementById("jumpBtn").addEventListener("touchstart", () => {
  if (onGround) {
    velocity.y = 0.18;
    onGround = false;
  }
});

// Jetpack
document.getElementById("jetpackBtn").addEventListener("touchstart", () => isJetpacking = true);
document.getElementById("jetpackBtn").addEventListener("touchend", () => isJetpacking = false);

function animate() {
  requestAnimationFrame(animate);

  // Horizontal input
  if (moveLeft) player.position.x -= 0.1;
  if (moveRight) player.position.x += 0.1;

  // Gravity / Jetpack
  if (isJetpacking && jetpackFuel > 0) {
    velocity.y += 0.01;
    jetpackFuel -= 0.5;
  } else {
    velocity.y -= 0.01;
  }
  player.position.y += velocity.y;

  // Ground detection
  onGround = false;
  platforms.forEach(p => {
    // Move platform
    if (p.type === 'move') {
      p.mesh.position.z += 0.05 * p.direction;
      if (Math.abs(p.mesh.position.z - p.startZ) > 3) p.direction *= -1;
    }

    const dx = Math.abs(player.position.x - p.mesh.position.x);
    const dz = Math.abs(player.position.z - p.mesh.position.z);
    const dy = player.position.y - p.mesh.position.y;

    if (dx < platformSize / 2 && dz < platformSize / 2 && dy >= 0 && dy < 1) {
      player.position.y = p.mesh.position.y + 1;
      velocity.y = 0;
      onGround = true;
      jetpackFuel = 100;

      if (p.type === 'disappear' && p.touchedAt === null) {
        p.touchedAt = performance.now();
      }
    }

    // Remove disappearing platform
    if (p.type === 'disappear' && p.touchedAt !== null) {
      const timeSinceTouch = performance.now() - p.touchedAt;
      if (timeSinceTouch > 1000) {
        scene.remove(p.mesh);
        p.mesh.geometry.dispose();
        p.mesh.material.dispose();
        p.touchedAt = -1;
      }
    }
  });

  // Fall reset
  if (player.position.y < -10) {
    player.position.set(0, 5, 0);
    velocity.set(0, 0, 0);
    jetpackFuel = 100;
  }

  // Auto move forward
  player.position.z += 0.08;

  // Camera follow
  camera.position.lerp(new THREE.Vector3(player.position.x, player.position.y + 5, player.position.z - 10), 0.1);
  camera.lookAt(player.position);

  renderer.render(scene, camera);
}

animate();
</script>
</body>
</html>
